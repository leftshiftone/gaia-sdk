task clean() {
    doLast {
        execute(["yarn", "clean"])
    }
}

task installDependencies() {
    doLast {
        execute(["yarn", "install"])
    }
}

task test() {
    doLast {
        execute(["yarn", "test"])
    }
}

task assemble() {
    doLast {
        execute(["yarn", "build"])
    }
}

task build() {
    dependsOn test, assemble
}

task publish() {
    doLast {
        execute(["npm", "set", "registry", "https://registry.npmjs.org/"])
        execute(["echo", "//registry.npmjs.org/:_authToken=${System.getenv("NPM_TOKEN")}", ">", "~/.npmrc"])
        execute(["npm", "publish"])
        //execute(["yarn", "npm", "publish", "--tolerate-republish"])
    }
}
publish.dependsOn assemble

private void execute(List<String> command) {
    logger.debug("Executing command '${command.join(" ")}'")
    def process = new ProcessBuilder(command).directory(projectDir).start()
    process.consumeProcessOutput(System.out, System.err)
    process.waitFor()
    if (process.exitValue() != 0) throw new RuntimeException("Command '${command.join(" ")}' failed with code ${process.exitValue()}")
    logger.debug("Executed command '${command.join(" ")}'")
}
